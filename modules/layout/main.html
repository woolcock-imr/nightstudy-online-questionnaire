VmInclude:/modules/layout/top-right-corner.html
VmInclude:/modules/layout/header.html
VmInclude:/modules/layout/content-container.html
VmInclude:/modules/layout/footer.html
<div id="fb-root"></div>
<div style='display:none'><div id="disqus_thread"></div></div>
<script>$vm.comments=1;</script>

<script main-layout-js>
	function F__ID(){
		//------------------------------------
		var website_item_list_for_search=[]
		//------------------------------------
		var set_height=function(){
			var header_height=$('#brand__ID').outerHeight(); $vm.header_height=header_height;
			var footer_height=$('#footer__ID').outerHeight();
			$vm.min_height=($(window).height()-header_height-footer_height);
			$('#content_container__ID').css({'height':$vm.min_height});
			$('#content_container__ID').css({'top':(header_height+1)+'px'})
			console.log('window:'+$(window).height()+', header:'+header_height+', footer:'+footer_height);
		}
		setTimeout(function (){	set_height();},100);	setTimeout(function (){	set_height();},2000);
		//------------------------------------
		window.onresize=function(e){set_height();};
		window.onmessage=function(e){
		    if(e.data.username!=undefined && e.data.user_id!=undefined){
		        $vm.user=e.data.username;
		        $vm.user_id=e.data.user_id;
		        $VmAPI.set_token(e.data.token,e.data.api_url,e.data.username,e.data.user_id,e.data.nickname);
		        location.reload(true);
		    }
		};
		//-----------------------------------------
		var modules=$vm.app_config.modules;
		for (var property in modules) {
		   	if($vm.module_list[property]==undefined){
			   	$vm.module_list[property]=modules[property];
				var nm=$vm.module_list[property]['name_for_search'];
				if(nm!=""){
					if(nm==undefined) nm=property;
					website_item_list_for_search.push({label:nm,value:property})
				}
		   	}
		}
		//------------------------------------
		//This is the place we can add background image to body (Asynchronous)
		var $image1 = $("<img>");
		$image1.on('load',(function(){ $('body').css("background", "url("+$(this).attr("src")+") no-repeat bottom center"); $('body').css("background-size", "cover");  }));
		$image1.attr("src", "__HOST__/images/background.jpg");
		//------------------------------------
		//over write vm alert
		$vm.alert=function(msg){
			$('#vm_alert_information div.modal-body').html( $('<div/>').html(msg).text() );
			$("#vm_alert_information").modal();
		}
		//------------------------------------
		var set_module_search=function(){
			$("#vm_system_search").autocomplete({
				minLength:0,
				source: function(request, response) {
					var results=$.ui.autocomplete.filter(website_item_list_for_search, request.term);
					response(results.slice(0, 10));
				},
				select: function(event,ui) {
					event.preventDefault();
					$('.navbar-collapse').collapse('hide');
					$("#vm_system_search").val('');
					$("#vm_system_search").blur();
					$('.ui-helper-hidden-accessible').html('');
					$vm.nav_load_module(ui.item.value);
				}
			});
			$("#vm_system_search").focus(function(){$("#vm_system_search").autocomplete("search","");});
		}
		//------------------------------------
		var load_home_module=function(){
			var a=window.location.href.split('module=');
			if(a.length!=2)	$vm.nav_load_module('main_home');
			else{
				var name=a[1].split('&')[0];
				if(name.length>0){
					if($vm.module_list[name]!=undefined){
						$vm.nav_load_module(name);
						return;
					}
				};
				alert("The module "+name+" doesn't exist!");
			}
		}
		//********************************************************
		var N=0;
		//********************************************************
		var add_config=function(text,group_name){
			var config;
			try{ config=JSON.parse(text);}
			catch (e){ alert("Error in config file\n"+e); return; }
			//--------------------------
			if(config.group_name!=undefined) group_name=config.group_name;
			//add modules to module list and some processing
			var modules=config.modules;
			for (var property in modules) {
			   	if($vm.module_list[group_name+"_"+property]==undefined){
				   	$vm.module_list[group_name+"_"+property]=modules[property];
					$vm.module_list[group_name+"_"+property].group_name=group_name;
					var nm=$vm.module_list[group_name+"_"+property]['name_for_search'];
					if(nm!=""){
						if(nm==undefined) nm=property;
						website_item_list_for_search.push({label:nm,value:group_name+"_"+property})
					}
			   	}
			}
			//--------------------------
			//add others to config
			for (var property in config){
				if(property!="modules" && property!="group"){
					$vm.app_config[property]=config[property];
				}
			}
			//--------------------------
			N--;
			if(N==0){
				set_module_search();
				load_home_module();
			}
		}
		//------------------------------------
		var process_config_file=function(url,group){
			console.log('loading '+url+'?_='+$vm.ver[1]+$vm.reload);
			$.get(url+'?_='+$vm.ver[1]+$vm.reload,function(data){
				localStorage.setItem(url+"_txt",data);
				localStorage.setItem(url+"_ver",$vm.ver[1]);
				add_config(data,group);
			},'text').fail(function() {
				alert( "The configuration file ("+url+") doesn't exist!" );
			});
		}
		//------------------------------------
		var groups=$vm.app_config.module_groups;
		if(groups!=undefined && groups.length>0){
			N=groups.length;
			//------------------------------------
			for(var i=0;i<groups.length;i++){
				var url=$vm.hosting_path+"/configurations/"+groups[i];
				var ver=localStorage.getItem(url+"_ver");
				var txt=localStorage.getItem(url+"_txt");
				if(ver!=$vm.ver[1] || txt===null || $vm.debug===true || $vm.reload!=''){
					process_config_file(url,groups[i].replace('.json',''));
				}
				else{ add_config(txt,groups[i].replace('.json','')); }
			}
			//------------------------------------
		}
		else{
            alert("No module group in the system!")
		}
		//------------------------------------
	}
</script>
<style main-layout-css>
    .vm_module{
        position:absolute;
        width:100%;
        height:100%;
		background-color: #fff;
    }
	html,body{
		height:100%;
		overflow-y:hidden;
	}
	@keyframes vm_module_fadein {
		from { opacity:0; }
		to {opacity:1;}
	}
    @keyframes vm_module_slide_in {
		from { margin-top:50%; }
		to {margin-top:0;}
	}
    @keyframes vm_module_slide_out {
        from { margin-top:0; }
		to {margin-top:-50%;}
	}
    .ui-autocomplete.ui-menu{font-size:12px}
	.ui-menu-item .ui-menu-item-wrapper:hover
	{
		font-weight:normal;
	}
</style>
